<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnippetWave Runner</title>
  <style>
    :root{--bg:#fff}
    html,body{height:100%;margin:0;background:var(--bg)}
    body{font:14px system-ui,"Segoe UI",Roboto,Arial,sans-serif;color:#344054}
    .wrap{max-width:1100px;margin:0 auto;padding:8px 12px 48px}
    .hint{color:#667085;margin:8px 0 14px}
    .slot{margin:14px 0 18px}
    .frame{width:100%;height:520px;border:1px solid #e7efe9;border-radius:12px;display:block;background:#fff}
    .empty{display:grid;place-items:center;height:60vh;color:#98a2b3}
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="empty" id="empty">En attente de code…</div>
    <div class="hint">Le runner peut recevoir plusieurs blocs : chaque message crée une nouvelle prévisualisation ci-dessous.</div>
  </div>

  <script>
    // --- utils ---
    const escScript = s => String(s).replace(/<\/script/gi,'<\\/script');

    function buildDoc(p){
      if (p && p.doc) return p.doc; // document entier fourni
      const html  = p && p.html  ? p.html  : '';
      const css   = p && p.css   ? `<style>${p.css}</style>` : '';
      const js    = p && p.js    ? `<script>${escScript(p.js)}</`+'script>' : '';
      const attrs = p && p.attrs ? `<div ${p.attrs}></div>` : '';
      return `<!doctype html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1" />
<base target="_blank" />
<style>html,body{margin:0;padding:12px;font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif}</style>
${css}
</head><body>
${html}${attrs}${js}
</body></html>`;
    }

    function renderOne(payload){
      const wrap = document.getElementById('wrap');
      const empty = document.getElementById('empty');
      if (empty) empty.remove();

      const slot = document.createElement('div');
      slot.className = 'slot';
      const frame = document.createElement('iframe');
      frame.className = 'frame';
      frame.referrerPolicy = 'no-referrer'; // propre
      // IMPORTANT : pas de sandbox ici → effets graphiques OK
      frame.srcdoc = buildDoc(payload || {});
      slot.appendChild(frame);
      wrap.appendChild(slot);
    }

    // 1) Handshake : on spam "ready" au parent jusqu’à recevoir du code
    let acked = false;
    const ping = setInterval(() => {
      try { parent.postMessage({ from:"sw-runner", ready:true }, "*"); } catch {}
    }, 200);

    // 2) Réception du code
    window.addEventListener('message', ev => {
      // Optionnel: on pourrait vérifier ev.origin si tu veux whitelister ton domaine Odoo
      try {
        const data = ev.data || {};
        if (data && (data.doc || data.html || data.css || data.js || data.attrs)) {
          acked = true;
          renderOne(data);
        }
      } catch(e){ console.error(e); }
    });

    // 3) Arrête le ping après 10s (au cas où)
    setTimeout(() => clearInterval(ping), 10000);

    // 4) Fallback: si la page est ouverte seule, supporte ?b64= et #b64=
    (function(){
      function getB64(){
        const q = new URLSearchParams(location.search);
        const p = q.get('b64');
        if (p) return p;
        if (location.hash.startsWith('#b64=')) return location.hash.slice(5);
        return null;
      }
      function decodePayload(b64){
        try { return JSON.parse(decodeURIComponent(atob(b64))); }
        catch { try { return JSON.parse(atob(b64)); } catch { return null; } }
      }
      const b64 = getB64();
      if (b64){
        const p = decodePayload(b64);
        if (p) renderOne(p);
      }
    })();
  </script>
</body>
</html>
