<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnippetWave Runner</title>
  <style>
    :root{--bg:#fff}
    html,body{height:100%;margin:0;background:var(--bg)}
    body{font:14px system-ui,"Segoe UI",Roboto,Arial,sans-serif;color:#344054}
    .wrap{max-width:1100px;margin:0 auto;padding:8px 12px 48px}
    .hint{color:#667085;margin:8px 0 14px}
    .slot{margin:14px 0 18px}
    .frame{width:100%;height:520px;border:1px solid #e7efe9;border-radius:12px;display:block;background:#fff}
    .empty{display:grid;place-items:center;height:60vh;color:#98a2b3}
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="empty" id="empty">En attente de code…</div>
    <div class="hint">Le runner peut recevoir plusieurs blocs&nbsp;: chaque message crée une nouvelle prévisualisation ci-dessous.</div>
  </div>

  <script>
    // --- utils ---
    const escScript = s => String(s).replace(/<\/script/gi,'<\\/script');
    function byId(id){ return document.getElementById(id); }

    function buildDoc(p){
      if (p && p.doc) return p.doc; // document complet fourni
      const html  = p && p.html  ? p.html  : '';
      const css   = p && p.css   ? `<style>${p.css}</style>` : '';
      const js    = p && p.js    ? `<script>${escScript(p.js)}</`+'script>' : '';
      const attrs = p && p.attrs ? `<div ${p.attrs}></div>` : '';
      return `<!doctype html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1" />
<base target="_blank" />
<style>html,body{margin:0;padding:12px;font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif}</style>
${css}
</head><body>
${html}${attrs}${js}
</body></html>`;
    }

    function renderOne(payload){
      const wrap = byId('wrap');
      const empty = byId('empty');
      if (empty) empty.remove();

      const slot = document.createElement('div');
      slot.className = 'slot';
      const frame = document.createElement('iframe');
      frame.className = 'frame';
      frame.referrerPolicy = 'no-referrer';
      // pas de sandbox ici, on garde les effets graphiques
      frame.srcdoc = buildDoc(payload || {});
      slot.appendChild(frame);
      wrap.appendChild(slot);
    }

    // --- décodeurs URL/hash ---
    function getParamB64(){
      const q = new URLSearchParams(location.search);
      const p = q.get('b64');
      if (p) return p;
      if (location.hash.startsWith('#b64=')) return location.hash.slice(5);
      return null;
    }
    function decodePayload(b64){
      try { return JSON.parse(decodeURIComponent(atob(b64))); }
      catch { try { return JSON.parse(atob(b64)); } catch { return null; } }
    }

    // 1) charge via ?b64=… ou #b64=…
    (function boot(){
      const b64 = getParamB64();
      if (b64){
        const payload = decodePayload(b64);
        if (payload) renderOne(payload);
      }
    })();

    // 2) supporte aussi postMessage (plusieurs blocs possibles)
    window.addEventListener('message', ev => {
      try { renderOne(ev.data || {}); } catch(e){ console.error(e); }
    });
  </script>
</body>
</html>
